\documentclass{article}

\usepackage{amsmath,amssymb, amsfonts}

\begin{document}
\section{Piman-Yor Diffusion Trees}
\subsection{Modelling of PYDT}	

	\begin{eqnarray}
		\alpha &\sim& \textrm{Beta}(\alpha | a_\alpha, b_\alpha) \\ 
		\theta &\sim& \textrm{G}(\theta | a_\theta, b_\theta) \\
		c &\sim& \textrm{G}(c | a_c, b_c) \nonumber \\
		&=& \frac{b_c^{a_c}c^{a_c - 1}e^{-b_c c}}{\Gamma(a_c)} \\ 
		1/\sigma^2 &\sim& \textrm{G}(1/\sigma^2 | a_{\sigma^2}, b_{\sigma^2}) \\
		p(t_v | c, \mathcal{T}) &=& c(1-t_v)^{cJ^{\theta,\alpha}_{\bold{n}_v} - 1} \\
		p(\bold{z}_v | \bold{z}_u, \sigma^2(t_v - t_u)\bold{I}) &=& (2 \pi \sigma^2(t_v - t_u))^{-\frac{D}{2}} \exp \Big(-\frac{1}{2}\frac{\parallel \bold{z}_v - \bold{z}_u \parallel^2}{\sigma^2 (t_v - t_u)} \Big) \\
		p(\bold{z}_k | \bold{z}_v, \sigma^2(t_k - t_v)\bold{I}) &=& (2 \pi \sigma^2(t_k - t_v))^{-\frac{D}{2}} \exp \Big(-\frac{1}{2}\frac{\parallel \bold{z}_k - \bold{z}_v \parallel^2}{\sigma^2 (t_k - t_v)} \Big) \\
		p(\bold{X}, \bold{Z} | \boldsymbol{\Theta}, \mathcal{T}) &=& \textrm{G}(c | a_c, b_c) \textrm{G}(1/\sigma^2 | a_{\sigma^2}, b_{\sigma^2}) \nonumber \\
		& & \prod^{|\mathcal{I}|}_{v \in \mathcal{I}} p(t_v | c, \mathcal{T}) p(\bold{z}_v|\bold{z}_u, \sigma^2(t_v - t_u)\bold{I}) \nonumber \\ 
		& & \prod^N_{n=1} p(\bold{x}_n|\bold{z}_{pa(n)}, \sigma^2(1 - t_{pa(n)})\bold{I}) \\
		& & \textrm{where } \bold{Z} = \{ c, \sigma^2, \bold{z}, \bold{t}\}, \boldsymbol{\Theta} = \{a_c, b_c, a_{\sigma^2}, b_{\sigma^2}\} \nonumber
	\end{eqnarray}

\subsection{EM algorithm for PYDT}	
	\begin{eqnarray}
		\ln P(\bold{X}|\boldsymbol{\theta}) &=& \ln \Big\{\sum_\bold{Z}P(\bold{X}, \bold{Z} | \boldsymbol{\theta}) \Big\} \nonumber \\
		&=& \ln \Big\{\sum_\bold{Z}q(\bold{Z})\frac{P(\bold{X}, \bold{Z}|\boldsymbol{\theta})}{q(\bold{Z})} \Big\} \nonumber \\
		&=& \sum_\bold{Z}q(\bold{Z})\ln \Big\{ \frac{P(\bold{X}, \bold{Z}| \boldsymbol{\theta})}{q(\bold{Z})} \Big\} + \sum_\bold{Z}q(\bold{Z})\ln \Big\{ \frac{q(\bold{Z})}{P(\bold{Z}|\bold{X}, \boldsymbol{\theta})} \Big\}
	\end{eqnarray}

The main procedure of the algorithm is as follows. \\
1) Find $q(\bold{Z})$ which minimizes the KL divergence. \\
2) Take a gradient of the ELBO w.r.t. $\boldsymbol{\theta}$ using $q(\bold{Z})$ found in the step 1).\par
The step 2) can be written as below.

	\begin{eqnarray}
	Q(\boldsymbol{\theta}, \boldsymbol{\theta}') &=& \sum_\bold{Z}q(\bold{Z})\ln \Big\{ \frac{P(\bold{X}, \bold{Z}| \boldsymbol{\theta})}{q(\bold{Z})} \Big\} \nonumber \\
	&=& \sum_\bold{Z}q(\bold{Z}) \ln P(\bold{X}, \bold{Z}| \boldsymbol{\theta}) - \sum_\bold{Z}q(\bold{Z})\ln q(\bold{Z})\\
	\frac{\partial Q(\boldsymbol{\theta}, \boldsymbol{\theta}')}{\partial \boldsymbol{\theta}} &=& \sum_\bold{Z} q(\bold{Z}) \frac{\partial \ln P(\bold{X}, \bold{Z}|\boldsymbol{\theta}) }{\partial \boldsymbol{\theta}} \nonumber \\
	&=& \sum_\bold{Z}p(\bold{Z}|\bold{X}, \boldsymbol{\theta}') \frac{\partial \ln P(\bold{X}, \bold{Z}|\boldsymbol{\theta}) }{\partial \boldsymbol{\theta}}
	\end{eqnarray}
	
\subsection{Posterior of $p(t_v | \mathcal{T})$}	
	
	\begin{eqnarray}
	p(t_v, \bold{z}_{\{u,v,k\}}, \sigma^2 | c, \mathcal{T}) & = & c(2 \pi \sigma^2)^{-\frac{D(K + 1)}{2}}\exp \Big\{(cJ^{\theta,\alpha}_{\bold{n}_v} - 1)\ln(1 - t_v) \nonumber \\
	 & & - \frac{D}{2} \big( \ln(t_v - t_u) + \sum_k \ln(t_k - t_v) \big) \nonumber \\
	 & & - \frac{\parallel \bold{z}_v - \bold{z}_u\parallel^2}{2\sigma^2}\frac{1}{t_v - t_u} - \sum_k \frac{\parallel \bold{z}_k - \bold{z}_v\parallel^2}{2\sigma^2}\frac{1}{t_k - t_v} \Big\}  \nonumber\\
	 &=& C_{\sigma^2} \exp \big\{ u(t_v) \big\}\\
	\frac{du}{dt_v} &=& -\frac{cJ^{\theta,\alpha}_{\bold{n}_v} - 1}{1 - t_v} - \frac{D}{2}\big( \frac{1}{t_v - t_u} - \sum_k\frac{1}{t_k - t_v}\big) \nonumber \\
	 & & + \frac{\parallel \bold{z}_v - \bold{z}_u\parallel^2}{2\sigma^2}\frac{1}{(t_v - t_u)^2} - \sum_k \frac{\parallel \bold{z}_k - \bold{z}_v\parallel^2}{2\sigma^2}\frac{1}{(t_k - t_v)^2} \nonumber \\
	 &=& -\frac{cJ^{\theta,\alpha}_{\bold{n}_v} - 1}{1 - t_v} - \frac{1}{2(t_v - t_u)^2} \big(D(t_v - t_u) - \frac{\parallel \bold{z}_v - \bold{z}_u\parallel^2}{\sigma^2} \big) \nonumber \\
	 & & + \sum_k \frac{1}{2(t_k - t_v)^2} \big(D(t_k - t_v) - \frac{\parallel \bold{z}_k - \bold{z}_v\parallel^2}{\sigma^2} \big) \nonumber \\
	 &=& A(t_v)\\
	 C_{\sigma^2} A(t_v)^{-1} \int \exp \big\{u(t_v)\big\}du &=& Z, \textrm{ but this integral is intractable!} \\
	 &\Rightarrow & \textrm{The range of integration w.r.t. $t_v$ is $0 < t_u \leq t_v \leq \min(t_k) < 1$, } \nonumber \\
	 & & \textrm{obtaining $Z$ by simply summing pdf by the interval $dt = 1e^{-2}$} \nonumber \\
	 & & \textrm{is computationally tractable for modern hardwares.} \nonumber \\
	 & & \textrm{A few $t$ points usually give sufficient accuracy for $Z$.} \nonumber \\
	\mathbb{E}_{p(t_v | \bold{z}_{\{u,v,k\}}, \sigma^2, c, \mathcal{T})}[t_v] &=& \frac{1}{Z} \int t_v p(t_v, \bold{z}_{\{u,v,k\}}, \sigma^2 | c, \mathcal{T}) dt_v \nonumber \\
	&=& \frac{1}{Z} C_{\sigma^2} A_\mu(t_v)^{-1} \int \exp \big\{ u_\mu(t_v)\big\}du
	\end{eqnarray}
	
\end{document}